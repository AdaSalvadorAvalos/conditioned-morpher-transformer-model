<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="http://localhost:5000/static/icon_website.jpg" type="image/jpeg">
    <title>CMT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0a2e 0%, #2d1b69 50%, #4c2a85 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e1e5e9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(26, 10, 46, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid rgba(138, 43, 226, 0.2);
        }

        .header {
    background:
                url('http://localhost:5000/static/wave.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: white;
    padding: 30px;
    text-align: center;
    position: relative;
}
        
.header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(45, 27, 105, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #8a2be2;
            border: 1px solid rgba(138, 43, 226, 0.3);
            transition: all 0.3s ease;
        }

        .section.hidden {
            opacity: 0.3;
            pointer-events: none;
            transform: translateY(10px);
        }

        .section h2 {
            color: #da70d6;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #8a2be2;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: rgba(55, 35, 95, 0.5);
        }

        .upload-area:hover {
            border-color: #da70d6;
            background: rgba(138, 43, 226, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.2);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            color: #8a2be2;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #bdc3c7;
            font-size: 1.1em;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(39, 174, 96, 0.2);
            border-radius: 5px;
            color: #2ecc71;
            font-weight: 500;
        }

        .audio-player {
            margin-top: 15px;
            width: 100%;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #da70d6;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 8px;
            font-size: 1em;
            background: rgba(30, 15, 55, 0.8);
            color: #e1e5e9;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #8a2be2;
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
            background: rgba(35, 20, 60, 0.9);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #8a2be2;
        }

        .checkbox-group label {
            color: #bdc3c7;
            font-size: 1em;
            cursor: pointer;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-group {
            background: rgba(40, 25, 75, 0.6);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(138, 43, 226, 0.2);
        }

        .control-group h3 {
            color: #da70d6;
            margin-bottom: 18px;
            font-size: 1.2em;
        }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 500;
            color: #bdc3c7;
        }

        .slider-value {
            background: linear-gradient(135deg, #8a2be2, #da70d6);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            min-width: 50px;
            text-align: center;
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(55, 35, 95, 0.8);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8a2be2, #da70d6);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(138, 43, 226, 0.4);
        }

        .slider::-webkit-slider-thumb:hover {
            background: linear-gradient(135deg, #da70d6, #8a2be2);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.6);
        }

        .slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8a2be2, #da70d6);
            cursor: pointer;
            border: none;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8a2be2, #da70d6);
            color: white;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #5a6c7d);
            color: white;
            border: 1px solid rgba(218, 112, 214, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(90, 108, 125, 0.3);
            background: linear-gradient(135deg, #3d566e, #6b7d8f);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .advanced-options {
            margin-top: 25px;
            padding: 25px;
            background: rgba(30, 15, 55, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(138, 43, 226, 0.2);
        }

        .advanced-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #da70d6;
            font-weight: 600;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .advanced-toggle:hover {
            color: #8a2be2;
        }

        .advanced-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .advanced-content.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .progress-container {
            margin-top: 25px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(55, 35, 95, 0.8);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8a2be2, #da70d6);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 12px;
            color: #bdc3c7;
            font-size: 0.95em;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
        }

        .status-success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
            color: #2ecc71;
        }

        .status-error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .status-info {
            background: rgba(138, 43, 226, 0.2);
            border: 1px solid #8a2be2;
            color: #da70d6;
        }

        .output-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(30, 15, 55, 0.6);
            border-radius: 12px;
            border: 2px dashed rgba(138, 43, 226, 0.3);
        }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .output-item {
            background: rgba(45, 27, 105, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 43, 226, 0.2);
        }

        .output-item h4 {
            color: #da70d6;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: calc(50% + var(--tooltip-offset-x, 0px)); /* Use offset if defined */
            transform: translateX(-50%);
            background: rgba(30, 15, 55, 0.95);
            color: #e1e5e9;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0.95;
            border: 1px solid rgba(138, 43, 226, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 768px) {
            .file-upload {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .custom-inputs {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
        }

        /* Step flow classes */
        .step-hidden {
            display: none !important;
        }

        .step-visible {
            display: block;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* File upload completion indicator */
        .upload-area.completed {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .upload-area.completed .upload-icon {
            color: #27ae60;
        }


        .genre-btn {
        padding: 10px 18px;
        border: 1px solid rgba(138, 43, 226, 0.4);
        border-radius: 8px;
        background: rgba(40, 25, 75, 0.6);
        color: #bdc3c7;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 5px;
        backdrop-filter: blur(5px);
    }

    .genre-btn:hover {
        border-color: #8a2be2;
        background: rgba(138, 43, 226, 0.15);
        color: #da70d6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.2);
    }

    .genre-btn.active {
        background: linear-gradient(135deg, #8a2be2, #da70d6);
        border-color: #da70d6;
        color: white;
        box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
        transform: translateY(-1px);
    }

    .genre-btn.active:hover {
        background: linear-gradient(135deg, #da70d6, #8a2be2);
        box-shadow: 0 6px 20px rgba(138, 43, 226, 0.5);
        transform: translateY(-3px);
    }

    .genre-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
        border-color: rgba(138, 43, 226, 0.2);
    }

    /* Container for genre buttons */
    .genre-buttons-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        align-items: center;
    }

    .selected-genres-message {
    color: #bdc3c7;
    margin-bottom: 20px;
    display: block;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Conditioned Morpher Transformer model (CMT)</h1>
            <p>Advanced Audio Loop Morphing with Neural Networks</p>
        </div>

        <div class="main-content">
            <!-- File Upload Section -->
            <div class="section" id="fileUploadSection">
                <h2>Audio Files</h2>
                <div class="file-upload">
                    <div class="upload-area" id="sourceUpload">
                        <div class="upload-icon">üéß</div>
                        <div class="upload-text">
                            <strong>Source Audio</strong><br>
                            Click or drag to upload
                        </div>
                        <input type="file" id="sourceFile" accept=".wav,.mp3,.flac">
                        <div class="file-info" id="sourceInfo" style="display: none;"></div>
                        <audio class="audio-player" id="sourcePlayer" controls style="display: none;"></audio>
                    </div>
                    
                    <div class="upload-area" id="targetUpload">
                        <div class="upload-icon">üéØ</div>
                        <div class="upload-text">
                            <strong>Target Audio</strong><br>
                            Click or drag to upload
                        </div>
                        <input type="file" id="targetFile" accept=".wav,.mp3,.flac">
                        <div class="file-info" id="targetInfo" style="display: none;"></div>
                        <audio class="audio-player" id="targetPlayer" controls style="display: none;"></audio>
                    </div>
                </div>
            </div>

            <!-- Model Configuration -->
            <div class="section step-hidden" id="modelConfigSection">
                <h2>üß† Model Configuration</h2>
                <div class="input-group">
                    <label for="checkpointPath">Model Checkpoint Path</label>
                    <input type="text" id="checkpointPath" placeholder="/path/to/model/checkpoint.pth" 
                           value="./models/dac_morpher_checkpoint.pth">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="useCPU">
                    <label for="useCPU">Force CPU Usage</label>
                </div>
            </div>

            <!-- Overall Morph Control -->
            <div class="section step-hidden" id="overallMorphSection">
                <h2>üéõÔ∏è Overall Morph Control</h2>
                <div class="control-group">
                    <h3>Basic Morph</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span class="tooltip" data-tooltip="Controls overall morphing between source and target" style="--tooltip-offset-x: 50px;">
                                Morph Ratio
                            </span>
                            <span class="slider-value" id="morphRatioValue">0.50</span>
                        </div>
                        <input type="range" class="slider" id="morphRatio" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    
                </div>
            </div>


            <!-- Custom Choices -->
            <!-- Custom Choices -->
            <div class="section step-hidden" id="customChoicesSection">
                <h2>üé® Custom Choices</h2>
                <div class="custom-inputs">
                    <div class="input-group">
                        <label class="tooltip" data-tooltip="Select target genres for morphing">
                            Target Genre Selection
                        </label>
                        <div class="genre-buttons" id="genreButtons">
                            <button type="button" class="genre-btn" data-genre="Blues">Blues</button>
                            <button type="button" class="genre-btn" data-genre="Brass & Military">Brass & Military</button>
                            <button type="button" class="genre-btn" data-genre="Children's">Children's</button>
                            <button type="button" class="genre-btn" data-genre="Classical">Classical</button>
                            <button type="button" class="genre-btn" data-genre="Electronic">Electronic</button>
                            <button type="button" class="genre-btn" data-genre="Folk, World, & Country">Folk, World, & Country</button>
                            <button type="button" class="genre-btn" data-genre="Funk / Soul">Funk / Soul</button>
                            <button type="button" class="genre-btn" data-genre="Hip Hop">Hip Hop</button>
                            <button type="button" class="genre-btn" data-genre="Jazz">Jazz</button>
                            <button type="button" class="genre-btn" data-genre="Latin">Latin</button>
                            <button type="button" class="genre-btn" data-genre="Non-Music">Non-Music</button>
                            <button type="button" class="genre-btn" data-genre="Pop">Pop</button>
                            <button type="button" class="genre-btn" data-genre="Reggae">Reggae</button>
                            <button type="button" class="genre-btn" data-genre="Rock">Rock</button>
                            <button type="button" class="genre-btn" data-genre="Stage & Screen">Stage & Screen</button>
                        </div>
                        <div class="selected-genres" id="selectedGenres">
                            <div style="margin-bottom: 20px; color: #bdc3c7;">
                                Selected genres will appear here
                            </div>                            
                        </div>
                        <label for="customGenreInput" class="tooltip" data-tooltip="Enter custom genre-subgenre (e.g., Blues---Boogie Woogie)">
                            Custom Genre - Subgenre (Style)
                        </label>
                        <input type="text" id="customGenreInput" placeholder="e.g., Blues---Boogie Woogie">
                        <small style="color:#74b9ff; display:block; margin-top:8px;">
                            View full list: <a href="http://localhost:5000/static/all_labels_master.json" target="_blank" style="color:#8a2be2;">genre_subgenre.json</a>
                        </small>                        
                    </div>
                    <div class="input-group">
                        <label for="customBPM" class="tooltip" data-tooltip="Specify target BPM value">
                            Custom Target BPM
                        </label>
                        <input type="number" id="customBPM" placeholder="e.g., 120" min="60" max="200">

                    </div>
                </div>
            </div>

            <!-- Generate Section -->
            <div class="section step-hidden" id="generateSection">
                <h2>üöÄ Generate</h2>
                <div class="button-group">
                    <button class="btn btn-primary" id="morphBtn" onclick="generateMorph()">
                        <span>üéµ</span> Generate Morph
                    </button>
                    <button class="btn btn-secondary" id="previewBtn" onclick="previewSettings()">
                        <span>üëÅÔ∏è</span> Preview Settings
                    </button>
                    <button class="btn btn-secondary" onclick="resetControls()">
                        <span>üîÑ</span> Reset Controls
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>

                <!-- Status Messages -->
                <div class="status-message" id="statusMessage"></div>
            </div>

            <!-- Output Section -->
            <div class="section step-hidden" id="outputMainSection">
                <h2>üì• Generated Output</h2>
                <div class="output-section" id="outputSection">
                    <p style="text-align: center; color: #bdc3c7; font-style: italic;">
                        Generated morphed audio files will appear here
                    </p>
                    <div class="output-grid" id="outputGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sourceFile = null;
        let targetFile = null;
        let isProcessing = false;
        let filesUploaded = false;
        let modelConfigured = false;


        // Call this on page load to test connection
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileUploads();
            initializeSliders();
            initializeCheckboxes();
            initializeStepFlow();
            initializeGenreButtons();
            
            // Test connection to Flask server
            setTimeout(testConnection, 1000);
        });

        function initializeGenreButtons() {
            const genreButtons = document.querySelectorAll('.genre-btn');
            const selectedGenresDiv = document.getElementById('selectedGenres');
            
            genreButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Toggle active state
                    this.classList.toggle('active');
                    
                    // Update selected genres display
                    updateSelectedGenresDisplay();
                });
            });
            
            function updateSelectedGenresDisplay() {
                const selectedButtons = document.querySelectorAll('.genre-btn.active');
                const selectedGenres = Array.from(selectedButtons).map(btn => btn.dataset.genre);
                
                if (selectedGenres.length > 0) {
                    selectedGenresDiv.innerHTML = `
                        <div class="selected-genres-message"><strong>Selected:</strong> ${selectedGenres.join(', ')}</div>
                    `;
                } else {
                    selectedGenresDiv.innerHTML = `
                        <div class="selected-genres-message">Selected genres will appear here</div>
                    `;
                }
            }
        }

        function initializeStepFlow() {
    // Monitor model config only - file monitoring is handled in initializeFileUploads
    document.getElementById('checkpointPath').addEventListener('input', checkModelConfig);
    document.getElementById('useCPU').addEventListener('change', checkModelConfig);
}

        function handleFileUpload(event) {
            // This will be called by the file upload handlers
            checkFilesAndShowNext();
        }

        function checkFilesAndShowNext() {
            if (sourceFile && targetFile && !filesUploaded) {
                filesUploaded = true;
                showSection('modelConfigSection');
                showStatus('Both files uploaded! Configure your model settings below.', 'success');
                
                // Mark upload areas as completed
                document.getElementById('sourceUpload').classList.add('completed');
                document.getElementById('targetUpload').classList.add('completed');
            }
        }

        function checkModelConfig() {
            const checkpointPath = document.getElementById('checkpointPath').value.trim();
            if (filesUploaded && checkpointPath && !modelConfigured) {
                modelConfigured = true;
                showSection('overallMorphSection');
                showSection('customChoicesSection');
                showSection('generateSection');
                showStatus('Model configured! You can now set morph parameters and generate.', 'success');
            }
        }



        function toggleCustomChoices() {
            const section = document.getElementById('customChoicesSection');
            const btn = document.getElementById('customChoicesBtn');
            
            if (section.classList.contains('step-hidden')) {
                showSection('customChoicesSection');
                btn.innerHTML = '<span>üé®</span> Hide Custom Choices';
            } else {
                hideSection('customChoicesSection');
                btn.innerHTML = '<span>üé®</span> Custom Choices';
            }
        }

        function showSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.remove('step-hidden');
            section.classList.add('step-visible');
            
            // Scroll to the newly shown section
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }

        function hideSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.add('step-hidden');
            section.classList.remove('step-visible');
        }

        function initializeFileUploads() {
    setupFileUpload('sourceUpload', 'sourceFile', 'sourceInfo', 'sourcePlayer', (file) => {
        sourceFile = file;
        updateMorphButtonState();
        checkFilesAndShowNext(); // Direct call instead of handleFileUpload
    });
    
    setupFileUpload('targetUpload', 'targetFile', 'targetInfo', 'targetPlayer', (file) => {
        targetFile = file;
        updateMorphButtonState();
        checkFilesAndShowNext(); // Direct call instead of handleFileUpload
    });
}

function setupFileUpload(uploadAreaId, fileInputId, infoId, playerId, callback) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const fileInfo = document.getElementById(infoId);
            const audioPlayer = document.getElementById(playerId);

            // Click to upload
            uploadArea.addEventListener('click', () => fileInput.click());

            // File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0], fileInfo, audioPlayer, callback);
                }
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0], fileInfo, audioPlayer, callback);
                }
            });
        }

        function handleFile(file, infoElement, playerElement, callback) {
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            const fileName = file.name;
            
            infoElement.innerHTML = `${fileName} (${fileSize} MB)`;
            infoElement.style.display = 'block';
            
            // Create URL for audio player
            const fileURL = URL.createObjectURL(file);
            playerElement.src = fileURL;
            playerElement.style.display = 'block';
            
            callback(file);
        }

        function initializeSliders() {
            // Morph Ratio Slider
            const morphRatio = document.getElementById('morphRatio');
            const morphRatioValue = document.getElementById('morphRatioValue');
            
            morphRatio.addEventListener('input', function() {
                morphRatioValue.textContent = parseFloat(this.value).toFixed(2);
            });

        
        }

        function initializeCheckboxes() {

    const morphRatio = document.getElementById('morphRatio');

    function updateMorphRatioState() {
        if (enableLoopMorph.checked || enableStyleMorph.checked || enableBPMMorph.checked) {
            morphRatio.disabled = true;
        } else {
            morphRatio.disabled = false;
        }
    }

}


        function updateMorphButtonState() {
            const morphBtn = document.getElementById('morphBtn');
            if (sourceFile && targetFile && !isProcessing) {
                morphBtn.disabled = false;
            } else {
                morphBtn.disabled = true;
            }
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message status-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            
            // Auto-hide after 5 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percentage + '%';
            progressText.textContent = `Processing... ${percentage}%`;
            
            if (percentage >= 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        function previewSettings() {
    const settings = gatherSettings();

    const overallMorphText = (settings.enableLoopMorph || settings.enableStyleMorph || settings.enableBPMMorph)
        ? 'Disabled (Advanced Ratios Active)'
        : settings.morphRatio;

    const preview = `
Settings Preview:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÅ Files:
‚Ä¢ Source: ${sourceFile ? sourceFile.name : 'Not selected'}
‚Ä¢ Target: ${targetFile ? targetFile.name : 'Not selected'}

üß† Model:
‚Ä¢ Checkpoint: ${settings.checkpointPath}
‚Ä¢ Use CPU: ${settings.useCPU ? 'Yes' : 'No'}

üéõÔ∏è Morph Settings:
‚Ä¢ Overall Ratio: ${overallMorphText}

üé® Custom Choices:
‚Ä¢ Target Style: ${settings.customStyle || 'Not specified'}
‚Ä¢ Target BPM: ${settings.customBPM || 'Not specified'}
    `;
    
    alert(preview);
}


function gatherSettings() {
    const selectedGenreButtons = document.querySelectorAll('.genre-btn.active');
    const selectedGenres = Array.from(selectedGenreButtons).map(btn => `"${btn.dataset.genre}"`);
    //const selectedGenres = Array.from(selectedGenreButtons).map(btn => `${btn.dataset.genre}`);
    
    const customInput = document.getElementById('customGenreInput').value.trim();
    if (customInput) {
        selectedGenres.push(`"${customInput}"`);
        // selectedGenres.push(`${customInput}`);
    }

    const customStyle = selectedGenres.join(' ');  // space-separated, all quoted

    return {
        checkpointPath: document.getElementById('checkpointPath').value,
        useCPU: document.getElementById('useCPU').checked,
        morphRatio: document.getElementById('morphRatio').value,
        customStyle: customStyle,
        customBPM: document.getElementById('customBPM').value
    };
}




function generateMorph() {
    if (!sourceFile || !targetFile) {
        showStatus('Please upload both source and target audio files.', 'error');
        return;
    }

    if (isProcessing) {
        showStatus('Processing already in progress. Please wait.', 'info');
        return;
    }

    const settings = gatherSettings();
    
    if (!settings.checkpointPath.trim()) {
        showStatus('Please specify a model checkpoint path.', 'error');
        return;
    }

    isProcessing = true;
    updateMorphButtonState();
    showStatus('Starting morph generation...', 'info');
    
    // Call the actual Flask API
    callFlaskAPI(settings);
}

// Replace the callFlaskAPI function with this fixed version
function callFlaskAPI(settings) {
    const formData = new FormData();
    
    // Add files
    formData.append('source', sourceFile);
    formData.append('target', targetFile);
    
    // Add required parameters
    formData.append('checkpointPath', settings.checkpointPath);
    
    // Always send morphRatio if no advanced ratios are enabled
    if (!settings.enableLoopMorph && !settings.enableStyleMorph && !settings.enableBPMMorph) {
        formData.append('morphRatio', settings.morphRatio);
    }
    
    // Add advanced ratio parameters only if enabled (send actual values, not just when enabled)
    if (settings.enableLoopMorph) {
        formData.append('morphRatioLoop', settings.loopMorphRatio);
    }
    
    if (settings.enableStyleMorph) {
        formData.append('morphRatioStyle', settings.styleMorphRatio);
    }
    
    if (settings.enableBPMMorph) {
        formData.append('morphRatioBPM', settings.bpmMorphRatio);
    }
    
    // Add custom parameters if provided
    if (settings.customStyle && settings.customStyle.trim()) {
        formData.append('TargetStyle', settings.customStyle.trim());
    }
    
    if (settings.customBPM && settings.customBPM.trim()) {
        formData.append('TargetBPM', settings.customBPM.trim());
    }

    // Start progress tracking
    updateProgress(10);
    
    // Make the API call with full URL
    fetch('http://localhost:5000/morph', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        updateProgress(80);
        
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error || 'Server error occurred');
            });
        }
        
        // Handle successful response (audio file)
        return response.blob();
    })
    .then(blob => {
        updateProgress(100);
        isProcessing = false;
        updateMorphButtonState();
        
        showStatus('Morph generation completed successfully!', 'success');
        showSection('outputMainSection');
        
        // Create download link for the generated audio
        const url = URL.createObjectURL(blob);
        const filename = `morphed_${settings.morphRatio}_${Date.now()}.wav`;
        
        generateActualOutput(url, filename, settings);
        
        // Scroll to output section
        setTimeout(() => {
            document.getElementById('outputMainSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 500);
    })
    .catch(error => {
        updateProgress(0);
        isProcessing = false;
        updateMorphButtonState();
        
        console.error('Error:', error);
        showStatus(`Error: ${error.message}`, 'error');
    });
}

// REPLACE the existing testConnection function with this one:
function testConnection() {
    fetch('http://localhost:5000/health')  // Added full URL
    .then(response => response.json())
    .then(data => {
        showStatus(`‚úÖ Connected to server: ${data.message}`, 'success');
    })
    .catch(error => {
        showStatus('‚ùå Cannot connect to server. Make sure Flask app is running on port 5000.', 'error');
        console.error('Connection error:', error);
    });
}

// Replace the generateOutputFiles function with this one for actual files
function generateActualOutput(audioURL, filename, settings) {
    const outputGrid = document.getElementById('outputGrid');
    const outputSection = document.getElementById('outputSection');
    
    // Clear existing output
    outputGrid.innerHTML = '';
    
    // Update output section text
    outputSection.querySelector('p').textContent = 'Generated morphed audio file:';
    
    // Create output item with actual audio
    const outputItem = document.createElement('div');
    outputItem.className = 'output-item';
    outputItem.innerHTML = `
        <h4>Morphed Audio</h4>
        <p style="color: #bdc3c7; margin-bottom: 10px;">
            Morphed at ${(parseFloat(settings.morphRatio) * 100).toFixed(0)}% blend ratio
        </p>
        <div style="margin-bottom: 15px;">
            <strong style="color: #74b9ff;">üìÅ ${filename}</strong>
        </div>
        <audio controls style="width: 100%; margin-bottom: 10px;" src="${audioURL}">
            Your browser does not support the audio element.
        </audio>
        <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="downloadActualFile('${audioURL}', '${filename}')">
            <span>üíæ</span> Download
        </button>
    `;
    outputGrid.appendChild(outputItem);
}

// Replace the downloadFile function with this one for actual downloads
function downloadActualFile(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showStatus(`Download started for ${filename}`, 'success');
}


function resetControls() {
    // Reset sliders
    document.getElementById('morphRatio').value = 0.5;
    document.getElementById('morphRatioValue').textContent = '0.50';
    
    // Reset checkboxes
    document.getElementById('enableLoopMorph').checked = false;
    document.getElementById('enableStyleMorph').checked = false;
    document.getElementById('enableBPMMorph').checked = false;
    document.getElementById('useCPU').checked = false;
    
    // Reset text inputs
    document.getElementById('customBPM').value = '';
    document.getElementById('checkpointPath').value = './models/dac_morpher_checkpoint.pth';
    
    // Reset genre button selections
    const genreButtons = document.querySelectorAll('.genre-btn');
    genreButtons.forEach(button => {
        button.classList.remove('active');
    });
    
    // Reset selected genres display
    const selectedGenresDiv = document.getElementById('selectedGenres');
    selectedGenresDiv.innerHTML = `
    <div class="selected-genres-message">Selected genres will appear here</div>
`;



    
    // Hide progress and status
    document.getElementById('progressContainer').style.display = 'none';
    document.getElementById('statusMessage').style.display = 'none';
    
    // Reset step flow
    filesUploaded = false;
    modelConfigured = false;
    sourceFile = null;
    targetFile = null;
    
    // Hide all sections except file upload
    hideSection('modelConfigSection');
    hideSection('overallMorphSection');
    hideSection('customChoicesSection');
    hideSection('generateSection');
    hideSection('outputMainSection');
    
    // Reset upload areas
    document.getElementById('sourceUpload').classList.remove('completed');
    document.getElementById('targetUpload').classList.remove('completed');
    document.getElementById('sourceInfo').style.display = 'none';
    document.getElementById('targetInfo').style.display = 'none';
    document.getElementById('sourcePlayer').style.display = 'none';
    document.getElementById('targetPlayer').style.display = 'none';
    
    // Reset button states
    updateMorphButtonState();
    document.getElementById('customChoicesBtn').innerHTML = '<span>üé®</span> Custom Choices';
    
    showStatus('All controls have been reset.', 'success');
}
    </script>
</body>
</html>